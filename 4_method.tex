\section{Method}
The general idea is to generate the medial axis transform and round the distance measures,
such that an exact integer beads will fit the polygon there
so that there is never a gap region left over in the middle of the polygon.

We round to integer multiples of half the nozzle width so as to allow single-bead segments, rather than only having polygonal insets.

\begin{figure}
\includegraphics[width=\columnwidth]{sources/method/rounded_vs_unrounded.pdf}
\caption{Toolpaths employing dist rounding vs without.}
\label{rounded_vs_unrounded}
\end{figure}


\begin{figure}
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/single_bead_strategy.jpg}
\caption{Overview}
\label{single_bead_strategy_overview}
\end{subfigure}
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/single_bead_strategy_order.jpg}
\caption{Travel order}s
\end{subfigure}
\caption{We can do single-bead segments. Blue is travel move.}
\label{single_bead_strategy}
\end{figure}

\subsection{Method Overview}
\begin{enumerate}
\item Determine the beading strategy: the optimal number of beads and their widths in order to cover a given distance with those beads.
\item Compute the medial axis transform (MAT)
\item Discretize the MAT and add extra segments such that the gMAT divides a polygon in quads
\item Mark significant high curvature portions of the gMAT
\item Introduce bones on marked regions where we transition to a different number of beads
\item Add ticks on non-marked regions according to the beading strategy.
\item Connect ticks and transition nodes into toolpaths.
\end{enumerate}


\hl{Idea: generate only outer 3 walls, except in marked regions where the distance $R < 5 \win$, so as to prevent jagged infill lines.}
\Cref{wedge_and_infill}

\hl{Filter beading number in order to prevent regions with a lot of back and forth transitions.}

\subsection{Terminology}
For an explanation of the terms used, see \cref{legend}.

\begin{figure}
\includegraphics[width=\columnwidth]{sources/method/legend_double_wedge_example.pdf}
\caption{Explanation of terms.}
\label{legend}
\end{figure}



\hl{We need consistent terminology and symbols which adhere to standards in literature.}
The following synonym groups are used here which are not yet checked with existing literature':
\begin{itemize}
\item bones, medial axis segments, arms, fingers, ribs
\item joints, ticks, medial axis vertices, locations
\item MAT distance measure
\end{itemize}


Based on the straight skeleton naming, I would like to introduce a new consistent terminology:
\begin{itemize}
\item marked medial axis segment: vertebra
\item marked medial axis: spine
\item non-marked medial axis segment: arm
\item any medial axis segment: bone
\item bone introduced to the medial axis: rib
\item medial axis vert: joint
\item location of an insets along a bone: tick? locus?
\end{itemize}












\subsection{Beading strategy}
First we determine how we should fill a 	polygon with constant width with a number of beads.
We want to fit an exact whole number of beads in order to prevent a gap being generated.
We consider only half of the polygon, because our beading strategy should be symmetrical.

We need a function $W$ from a given radial distance $R(v)$ to a number of beads and their widths.
These widths depend on the following parameters:
\begin{description}
\item[$\wmin$] the minimum possible bead width
\item[$\wmax$] the maximum possible bead width
\item[$\wout$] the preferred bead width of the outer inset
\item[$\win$] the preferred bead width of the other insets
\end{description}

The function $W$ needs to be able to deal with a range which is considerably shorter than $[\wmin, 2\wmin]$, even so short as to accomodate just $[\win,\win]$ only.
The function needs to be such that we never overshoot the radial distance $R(v)$, because that would affect the dimensional accuracy.
Any distance left over which cannot be filled given the range $[\wmin, \wmax]$ should be placed on the inside near the MAT.

We define $W(d)$ as a sequence of bead widths.
The length of that sequence is $b(d)$.
For example: with $\win = \SI{0.4}{\milli\meter}$ we could have $b(1.05) = 2.5$ and $W(1.05) = (0.4, 0.4, 0.5)$.
The last number is the innermost bead width if there is a singleton bead along the medial axis; only half of that bead spans along a radial distance.

The function $b$ should adhere to several criteria:
\begin{itemize}
\item $b \left( \frac12 n\win \right) = \frac12 n$ for integer $n$
\item $b$ is monotonic
%the item below follows from the two above
% \item between a location with radial distance $R(v) \in [\frac12 n\win, \frac12 (n+1)\win]$ (for integer $n$) there is only one transition to a different number of beads
\item $ 0 \leq b(d) \leq d / w_\text{min} $
\item the width $W(c, d)_n$ of each bead $n$ increases monotonically and gradually in regions with constant bead count $c$: $0 \leq \frac{\partial W(c, d)_n}{\partial d} < \infty$.
\end{itemize}

For our method we also require the inverse $b^{-1}(n)$ which gives the smallest $d$ for which $b(d) = n$.

For our application we define a $W$ adhereing to the following aditional constraints in order of priority:
\begin{itemize}
\item Minimize unfilled area
\item Try to get the outer bead width $W_1$ as close as possible to $\wout$
\item Have the rest of the $W_n$ the same width
\item at transition regions decide between $n$ and $n+1$ beads using the Loss fuction scheme below
\item From a $d$ for which $b(d) = 3$ we don't consider fractional $b(d)$ anymore; we don't allow singleton beads along the medial axis.
\hl{Perhaps we should disallow this because that would require a different transition length}
\end{itemize}

\iffalse
\begin{align}
W(d)_1 = 
  \begin{cases} 
%  \infty & \text{if } w < w_\text{min} \\
   \wout & \text{if } d \geq \wout + \wmin \\
   w - \wmin  & \text{if } 2\wmin  \leq d < \wout + \wmin
  \end{cases}
\end{align}
\fi

%\subsubsection{Optimal beading strategy}
%We could decide on a beading strategy based on some loss function $L$ defined on each line width.

\begin{align}
L(w_1) &= 
  \begin{cases} 
%  \infty & \text{if } w < w_\text{min} \\
   (w - \wout) / (\wmax - \wout) & \text{if } w > \wout\\
   (\wout - w) / (\wout - \wmin)       & \text{otherwise}
  \end{cases}
  \\
L(w_n) &= 
  \begin{cases} 
%  \infty & \text{if } w < w_\text{min} \\
   (w - \win) / (\wmax - \win) & \text{if } w > \win\\
   (\win - w) / (\win - \wmin)       & \text{otherwise}
  \end{cases}
\\
L(W(d)) &= \left(b(d) - \lfloor b(d) \rfloor \right) L \left( W(d)_{\lceil b(d) \rceil} \right)  +  \sum_{n=1}^{n=\lfloor b(d) \rfloor} L( W(d)_n )
\end{align}

(Singular beads are counted only half.)
Together these prioritized constraints uniquely define a single $W$, depending on $\wmin, \wmax, \wout,\win$.
An example is given in \cref{transition_location}.

\begin{figure*}
\centering
\includegraphics[width=.9\textwidth]{sources/method/ticking_v2.pdf}
\caption{Mapping of different lengths to a ticking. Transition location on a line-line segment is to the right of the middle because the preferred line width is to the left of the middle in the range.}
\label{transition_location}
\end{figure*}

We introduce a function which produces the $d$ at which all widths are prefered: 
\begin{align}
p(n) =
  \begin{cases} 
   \frac12 \wout & \text{if } n = \frac12 \\
    \wout + (n - 1) \win       & \text{otherwise}
  \end{cases}
\end{align}
We call a distance $d$ `prefered' when $d = p(b(d))$














\subsection{Skeletonization}
In order to apply the beading strategy to an arbitrary outline polygon we look at the skeleton of the polygon.
There are several possible skeletonal structures we could consider.


\subsubsection{Background}
The medial axis is defined by the locations where the inscribed circle meets the boundary in at least two locations. \todo{[citation needed]}
See \cref{MAT_explanation}.

``Because of its shape, the medial axis of a figure is also called the skeleton or the symmetric axis of the figure.
Associated with the medial axis is a radius function $R$, which defines for each point on the axis its distance to the boundary of the object.''
\cite{lee1982medial}

The medial axis along with the feature radius combine into a complete feature decsriptor, called the medial axis transform (MAT).
The MAT can unambiguously recreate the exact input shape. \todo{[citation needed]}

\cite{Moesen2011} provides a thorough overview of all MAT algorithms.
\cite{Moesen2011} calls $R$ the `feature radius': ``In every point $p \in P$, and thus also in points on the MA, the feature radius $\text{rad}(p)$ of $p$ can be defined as the Euclidean distance to the closest point on the boundary of $P$.''


\begin{figure}
\centering
\includegraphics[width=.9\columnwidth]{sources/intro/medial_axis_Kao.png}
\caption{MAT explanation by \citeauthor{kao1998optimal}}
\label{MAT_explanation}
\end{figure}



\begin{figure}
% from /home/t.kuipers/Documents/PhD/Variable_Width_project/pathplanning preliminaries/straight_skeleton_vs_medial_axis.svg
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/example_straight_skeleton.pdf}
\caption{Straight skeleton}
\end{subfigure}
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/example_medial_axis.pdf}
\caption{Medial axis}
\end{subfigure}
\caption{Example polygon middle analysis thingies. Difference is colored.}
\label{medial_axis_vs_straight_skeleton}
\end{figure}


\begin{figure}
\begin{subfigure}{0.24\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/MAT_example.pdf}
\caption{MAT}
\end{subfigure}
\begin{subfigure}{0.24\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/Voronoi_example.pdf}
\caption{Voronoi}
\end{subfigure}
\begin{subfigure}{0.24\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/gMAT_example.pdf}
\caption{gMAT}
\end{subfigure}
\begin{subfigure}{0.24\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/gMAT_example_labeling.pdf}
\caption{Quads}
\end{subfigure}
\caption{Grounded medial axis transform. Dark red are linear segments,  bright red are parabolic segments with high curvature, parabola segments with low curvature are purple. The labelings of areas show that the gMAT divides the area into quads and triangles and that the medial axis divides the area into sub-areas for each outline polygon.}
\label{gmat}
\end{figure}



\subsubsection{Voronoi Quadrangulation}
The medial axis of a polygonal shape can be obtained from the Voronoi Diagram (VD) generated on the line segments and vertices of the shape. \cite{lee1982medial}
First we throw away all locations in the Voronoi diagram which fall outside the boundary shape.
We can then obtain the medial axis by further reducing the Voronoi bones connected to a concave corner in the boundary shape.

However, instead of removing bones from the Voronoi diagram we will introduce more bones such that the skeleton discretizes the boundary shape into quads within which the $R$ can be interpolated linearly.
We call the resulting skeletonization the \emph{Voronoi Quadrangulation} (VQ).
The VQ greatly simplifies the processing required downstream in our framework.

In order to generate the VQ, we start by generating a normal Voronoi Diagram and remove all segments which lie outside of the boundary shape.
We then introduce bones such that each node in the VQ is directly connected to the outline via a single bone:
each node in the VQ is connected to the closest points on the boundary (its \emph{support}).
As such the VQ divides the polygon in quads consisting of 1 outline segment and 3 bones, one of which is not directly connected to the outline.
For concave verts the quad is missing the outline segments and so it regresses into a triangle;
likewise for convex sections it may happen that the inner bone is missing from the quad so that it forms a triangle.
\todo{TODO: make pics}

We then also discretize parabolic bones and bones generated by two concave outline vertices into approximately equidistant segments.
That way we can approximate the feature radius $R$ in between two nodes $v_0$ and $v_1$ in the VQ by interpolating linearly between $R(v_0)$ and $R(v_1)$.
Furthermore, we can linearly interpolate the distance field of a quad $p_0v_0v_1p_1$ (where $p_0$ and $p_1$ lie on the outline shape):
For a point $a \in p_0v_0$ and a point $b \in p_1v_1$ for which $R(a) = R(b)$ we have that all points in the line segment $ab$ have the same feature radius $R$.

i

\begin{figure}
\centering
\includegraphics[width=.8\columnwidth]{sources/method/voronoi_MAT.png}
\caption{From \citeauthor{lee1982medial} \cite{lee1982medial}}
\label{voronoi_MAT}
\end{figure}



\subsection{Beading}
We assign a beading to each significant node (and each local optimum).

\subsubsection{Significance measure}\label{sec:significance_measure}
\Cref{rounded_dist_measures}
We mark bones as to-be-transformed based on the angle between the two edges of the polygon for which this bone is the bisector.
Equivalently we can look at the \emph{bisector angle} $\alpha$ between a skeletal point and the two closest points on the outline.
(Same definition as \cite{attali1996modeling}.)

Contrary to common techniques we will \emph{keep} the insignificant regions of the skeleton.

\paragraph{line-line bones}
When the angle between two outline segments is small, the naive method will produce long triangular gaps.
A computationally efficient way to compute $\alpha$ can be obtained by looking at the ratio between $R$ and Euclidean distance.
Equivalently we can compare the Euclidean distance between two vertices with the difference in distance measure;
if $ |v_1 - v_0| > 2 | R(v_1) - R(v_0) |$ then $\alpha > \SI{120}{\degree}$.

\begin{figure}[H]
\centering
\includegraphics[width=.9\columnwidth]{sources/method/distance_based_angles.pdf}
\caption{Distance based angle estimation. By comparing the euclidean distance between two vertices with the distance measure of the MAT we can skip comparing the angles between the outline segments.}
\label{distance_based_angles}
\end{figure}

The Euclidean distance between two MAT vertices can never be less than the difference in the MAT distance measure between the vertices:t
\begin{figure}[H]
\centering
\includegraphics[width=.3\columnwidth]{sources/method/distance_ratio_limit.pdf}
\caption{Minimal Euclidean distance for a given difference in MAT distance measure.}
\label{distance_ratio_limit}
\end{figure}




\paragraph{line-point segments}
For a parabola MAT segment generated by point $(0,d)$ and an outline segment lying on the x-axis, the parabola is given by $y = \frac{1}{2d} x^2 + \frac12 d$.
If $\alpha > \SI{120}{\degree}$ then $\tan^{-1} \abs \partial y / \partial x < \SI{30}{\degree}$,
i.e.  $\tan^{-1} \abs x/d < \SI{30}{\degree}$,
i.e. when $\abs x/d < 1 / \sqrt{3}$,
i.e. when $\abs x < d \sqrt{3} / 3$.
So we mark the part of the parabola as to-be-transformed for which $x \in [-d \sqrt{3} / 3, d \sqrt{3} / 3]$.

\begin{figure}[H]
\centering
\includegraphics[width=.5\columnwidth]{sources/method/end_of_markings_point_line.pdf}
\caption{End-of-markings for a parabolic spine segment.}
\label{end_of_markings_point_point}
\end{figure}




\paragraph{point-point bones}
For a segment gerenated by points $(0,0)$ and $(0,d)$, the angle $\alpha > \SI{120}{\degree}$ when $\abs(x) < \frac12 d \tan \SI{30}{\degree} $,
so we mark the part of the straight MAT segment as to-be-transformed for which $x \in [-d \sqrt{3}/6, d \sqrt{3}/6]$.

\begin{figure}[H]
\centering
\includegraphics[width=.3\columnwidth]{sources/method/end_of_markings_point_point.pdf}
\caption{End-of-markings for the segment(s) generated by two outline verts.}
\label{end_of_markings_point_point}
\end{figure}








\paragraph{MAT distance transform}
In order to apply the beading strategy to the MAT
we assign each node $v$ of the medial axis a bead quantity $B^*$ which is initially based on $b(R(v))$, but it is modified in order to prevent discontinuities and remaining gaps.

\hl{How should we define $B^*$? Currently it is always the rounded measure, but it needs to be unrounded in non-marked areas and it needs to support fractional numbers around transitions!}

The bead quantity measure $B^*$ measure should be rounded
where the MAT distance measure $R$ is a local maximum: when all directly connected nodes have a lower MAT distance measure.
See bottom of \cref{rounded_vs_unrounded}.



\subsubsection{Transitioning}

\begin{figure}
\centering
\includegraphics[width=.6\columnwidth]{sources/method/rounded_dist_measures.jpg}
\caption{MAT distance measures at existing joints can be non-integer multiples of bead width.}
\label{rounded_dist_measures}
\end{figure}

See \cref{rounded_dist_measures}.

In order to prevent discontinuities in the toolpaths around locations $p$ where $\exists n : R(p) = b^{-1}(n)$ (see \cref{transition_location}), we need a way to smoothly transition to a different number of beads around locations where the 3D model has a changing radius.
The transition will be placed so as to overlap the locations of $b^{-1}(n)$.

On the one side of the transition we will have $b^*(v_0)=\frac12 n$ and on the other side we will have $b^*(v_1)=\frac12 n + \frac12$.
For all locations on the MAT in between we linearly interpolate the $b^*$ values, so that we can later interpolate the bead widths $W$ linearly as well.



In a narrow wedge region (a.k.a. a cusp) we have to transfer from $n$ to $n+\nicefrac12$ beads; this transition requires a distance.
See \cref{single_bead_strategy_overview}.
The transition will be such that the innermost toolpath makes a \SI{45}{\degree} angle with the medial axis.
The length of the transition along the medial axis depends on the angles involved.
See \cref{transition_length}.
\begin{equation}
t = r_0 (\sin \alpha + \cos \alpha)
\end{equation}

\begin{figure}[H]
\centering
\includegraphics[width=.75\columnwidth]{sources/method/transition_length_v2.pdf}
\caption{Transition length on a line-line segment.}
\label{transition_length}
\end{figure}

The position of a transition should be at a location $p$ where $\exists n : R(p) = b^{-1}(n)$.
However, given the fact that a transition is a region rather than a point, which part of the transition should be ceneterd at $p$?
For a transition from $n$ to $n+\frac12$ beads, we place a fraction of the transition length toward the end with lower $R$ proportional to it's positioning within the region of non-prefered widths:
$ (b^{-1}(n+\frac12) - p(n) ) / (p(n + \frac12) - p(n))$

\begin{figure}[H]
\centering
\includegraphics[width=.5\columnwidth]{sources/method/transition_location_precise.pdf}
\caption{Transition placement. The anchor position within the transition length is proportional to the transition location within the range between two distances with prefered length. \hl{outdated functions and variables!}}
\label{transition_length}
\end{figure}

\hl{How to deal with non-marked regions shorter than the transition length?}


The transition needs to be robust against extra fingers in the MAT.
How do we compute the vertex location of an inset on a finger which crosses a transitioning area?
By interpolating the MAT distance between the two ends of the transition, we obtain a stable method for determining the vertex locations of insets.
See \cref{distance_rounding_transition}.
The extra fingers (blue) cause a negligible difference in the inset path (compare the black dashed pat hwith the red dashed path).
\hl{What does it look like for point-line segments or point-point segments?}

\begin{figure}[H]
\centering
\includegraphics[width=.9\columnwidth]{sources/method/distance_rounding_transition.pdf}
\caption{MAT distance remapping.}
\label{distance_rounding_transition}
\end{figure}


\subsubsection{Ends of markings}
For vertices at the end of a sequence of marked MAT segments we need to take care of transitions.
If a transition is overlapping the end of the sequence, then either end of the transition would fall beyond the area where transitions should occur.
How should we deal with thse?
\begin{itemize}
\item We need to keep the transition tick on the marked side, because we need to switch to a different number of ticks somewhere.
Moreover, leaving out the whole transition around end-of-markings would violate the stability principle.
\item The end-of-marking itself will retain its interpolated MAT distance as described above.
\item The transition tick on the non-marked side of discarded.
This means that there will also be no single bead segment leading up to the transition, which coincides with how we deal with non-marked areas.
See \cref{single_bead_strategy}.
\end{itemize}
This method of dealing with end-of-markings can result in gaps slightly larger than usual.
See \cref{change_to_marked}.

\begin{figure}[H]
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/change_to_marked.pdf}
\caption{before end of markings}
\end{subfigure}
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/change_to_marked_2.pdf}
\caption{after end of markings}
\end{subfigure}
\caption{Transition near end of markings. The gap depends on the positioning of the middle of the transition (dotted lines) with respect to the end of the marked areas.}
\label{change_to_marked}
\end{figure}


It impossible for three marked edges to come together.
(Simple case) If 2 edges of the MAT meet then 3 outline segments are involved; lines through those segments form a triangle which cannot have more than two angles less than \SI{60}{\degree}.
However, what if we connect two marked segments using a small non-marked segment?
There is a distance limit based on \cref{distance_ratio_limit}:
the connecting segment is always larger in Euclidean distance than the difference in MAT distance.




\subsubsection{Introduce joints at transition ends}
At the locations $v$ of prefered width, i.e. when $R(v) = p(b(R(v)))$.
We discretize the distance measure field piecewise linear.
In \cref{distance_rounding_transition} we have one piece at MAT dist $0.0$ from bar $0$ to bar $2.5$, than a piece increasing from MAT dist $0.0$ to $1.0$ from bar $2.5$ to $7.5$ etc.

At the end of a marked section we round the MAT distance measure to the nearest integer and introduce a joint there and connect it to the outline using a new finger.
At those places we round the distance measure without applying transitioning, because the end of the transition would lie beyond the marked region.
 
\paragraph{Note}
We could introduce bones implicitly.
Instead of changing the straight skeleton and introducing bones,
we can simply introduce new vertices on the polygon and generate a new straight skeleton.

\old{
One could think that this means that the method for introducing joints in the original medial axis should be the same method as used for introducing joints on the newly added fingers connected to the joints introduced in the first step!
}
However, the method for introducing joints on the marked regions may differ from the method for introducing joints on the non-marked regions!


\subsubsection{Connect introduced joints to outline}
\old{
\paragraph{Angle of fingers introduced on the skeleton}
\Cref{finger_angles}
Cannot be optimized.
Always has to be orthogonal to the polygon segment.
Otherwise the algorithm isn't stable w.r.t. extra vertices in the outline.
}
\begin{figure}[H]
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/finger_angles.jpg}
\caption{Stability against extra vertices}
\label{finger_angles_stability}
\end{subfigure}
\begin{subfigure}{0.45\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/finger_angles_2.jpg}
\caption{Wrong rib angle, not orthogonal to outline}
\end{subfigure}
\caption{Finger angles should always be orthogonal to the outlines}
\label{finger_angles}
\end{figure}

\begin{wrapfigure}[5]{r}{0.2\linewidth}
\begin{center}
\includegraphics[width=\linewidth]{sources/method/min_angle_of_introduced_bones.pdf}
\end{center}
\end{wrapfigure}

Because the ribs are always orthogonal to the outline segments, the angle $\alpha$ between the spine and ribs is within the range $\SI{60}{\degree} < \alpha < \SI{90}{\degree}$.











\subsection{Toolpath extraction}

\subsubsection{Tick placement}
\hl{Change terminology: location $\to$ junction?}

Now that we have the skeleton set up, we determine the locations along the bones where the vertices of the toolpath polygons should be.
For marked regions / significant regions we have already inroduced joints around the transitions which serve as those locations.
For non-marked regions / unsignificant regions we can simply apply the beading strategy in order to find the toolpath verts.


This needs to be stable against small perturbations in the outline polygon.
See \cref{heterogeneous_joint_generation}.
For any sequence on non-marked bones from the outline polygon inward we define the stable end point as the first vertex which is connected to a marked medial axis segment.
Based on the MAT distance $R$ there we place ticks along the non-marked bones following the beading strategy.

\begin{figure}
\includegraphics[width=\columnwidth]{sources/method/heterogeneous_joint_generation.pdf}
\caption{Toolpaths employing dist rounding vs without.}
\label{heterogeneous_joint_generation}
\end{figure}




\subsubsection{Spacing problems}
Applying a beading strategy to the skeleton might not be trivial.
The trivial approach explained above introduces slight deviations from the beading strategy at intermediate locations in a quad.
When the widths are always the same this doesn't happen, but with widths changing throughout a quad this can pose a slight problem.

In the end this problem comes down to the fact that the medial axis is the location of quench sites when performing homogeneous insets.
Changing the bones for the chosen beading strategy is impossible, because the new skeleton would then induce a new beading strategy.
While this process could converge, it would spend too much computation time for only a small benefit.


(In this subsection we assume an even spacing beading strategy, i.e. $\win = \wout$.)


A related problem is that that applying the beading strategy to highly skewed quads would not be stable to the addition of extra bones.
See \cref{quad_instability}.
\hl{We should introduce bones in such a case!}

\begin{figure}[H]
\centering
\includegraphics[width=.5\columnwidth]{sources/method/quad_instability.pdf}
\caption{The addition of the extra bone (orange) causes a significant change from the dark red path to the green path.}
\label{quad_instability}
\end{figure}



See \cref{angular_based_spacing}.
One could think we should not space the joints evenly along the bones, but make the spacing depend on the angles involved.
We could check the intersection point of the lines of two polygon segments and radially project lines with the same angular spacing.
However, the angular spacing for two patches connected to a single bone would be different, so the paths wouldn't connect!
\hl{Does that mean the angle of the bones should ideally be updated?}


\begin{figure}
\centering
\includegraphics[width=.5\columnwidth]{sources/method/angular_based_spacing.pdf}
\caption{Angular based spacing isn't feasible. The bottom medial axis bone has different spacing based on the two patches. The radially evenly spaced lines are drawn in cyan for the interaction between the bottom outline segment with the top segment and in purple for the interaction between the second bottom segment with  the top segment.}
\label{angular_based_spacing}
\end{figure}


\paragraph{Ideal parabolas}
Subdividing bones introduced for parabolas evenly leads to even spacing along the bone,
while a derived formula seems to produce even spacing in a different sense:
See \cref{medial_axis_parabolas}

\begin{figure}
\begin{subfigure}{0.9\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/medial_axis_even_spacing.jpg}
\caption{Parabola transformed to straight skeleton and offsets using even spacing along bones.}
\end{subfigure}
\begin{subfigure}{0.9\columnwidth}
\includegraphics[width=\columnwidth]{sources/method/medial_axis_uneven_spacing.pdf}
\caption{Parabola function plots from analytical solutions where the distance to the point is a whole fraction of the distance to the line.}
\label{medial_axis_parabolas_functions}
\end{subfigure}
\caption{The equidistant points between a vert and a line form a parabola. There are different methods for generating toolpaths which are in between the medial axis and the outline. Note that the uneven spacing does \emph{not} coincide with an even angular spacingat the border between the patches: see the left side of \subref{medial_axis_parabolas_functions}.}
\label{medial_axis_parabolas}
\end{figure}

\hl{But the uneven spacing figure looks like its evenly spaced in the direction orthogonal to the toolpath itself!}




\subsubsection{Processing order}
\hl{How do we process the graph?}
\begin{itemize}
\item walk along polygons and for each vert walk down the graph up to the desired depth
\item process nodes in depth first order
\item process nodes in $R$ sorted order
\end{itemize}

We would require either a mapping from locations or bones to toolpath segments, which we can use to efficiently connect paths together.

Or we process all segments in order of the polygon, but then we need to track which polygons have been processed.

If we don't process both sides of the gMAT at the same time then we should record certain calculations such as the transition locations and maye also the parabola sample points.

\hl{Is there or should there be a specific ordering on the bones connected to a joint?}
A joint can have multiple parents.
We could order the bones cyclically, irrespective of whether they are going `up' or `down'.




\paragraph{Printing order}
The order in which beads are printed has influence on the quality and dimensional accuracy of a print.
If the inner beads are printed first then small inaccuracies in the deposition process propagate outward and the final outline of the print layer will be less accurate.
However, if the second bead is printed before the outer bead then the outer bead has more material to adhere to, which lessens the overhang constraints.
We therefore choose to print the inner beads first starting from the second bead and at the very end print the outermost bead.


When all extrusion segments are generated, we combine them into semi-continuous polyline toolpaths.
These polylines generally form closed polygons, but at significant regions of the VQ the toolpaths consist of single bead polyline toolpaths.
See \cref{single_bead_strategy}.
These single bead polylines can connect to polygonal toolpaths and they can also meet each other at 3-way junctions.
We determine the printing order for all segments of a given bead index by minimizing the travel distance using a greedy path order optimizer.
\todo{[implementation needed!]}


In general the toolpath location should be centered on the middle of the bead.
However, when the bead width is smaller than the nozzle size we might want to offset the toolpath toward a previously printed bead.
That way the previously printed bead occludes part of the hole in the nozzle such that the unoccluded hole is as wide as the required bead width.
The printing order and the toolpath positioning of the beading strategy are therefore interrelated.

Around 3-way junctions we need to prevent overextrusion.
We need to reduce the extrusion amount after the first time we pass an intersection: commonly known as \emph{ghosting}.
See \cref{ghosting}.
In order to realize the reduction we remove a section from the extrusion bead up to a distance equal to the feature radius from the junction.


\begin{figure}
\centering
\includegraphics[width=.99\columnwidth]{sources/method/ghosting.pdf}
\caption{Ghosting prevents over-extrusion at junctions.}
\label{ghosting}
\end{figure}




\begin{figure}[H]
\centering
\includegraphics[width=.99\columnwidth]{sources/method/wedge_and_infill.pdf}
\caption{Use single and double wall lines in regions where the infill would be too thin.}
\label{wedge_and_infill}
\end{figure}



\subsection{Overview}
Below in \cref{parabola_switch_to_less_lines} you can see the different technique preliminaries thought out.
The problem this paper is trying to solve is the large gap in M0.
M1, M2 and M3 use vertices at specific locations and use altered distance measures for those points; these methods are not stable to adding more bones to the skeleton.
M4 and M5 define distance measures in any location (based on \cref{distance_rounding_transition}) which makes them stable.
M5 avoids jagged lines by only applying the MAT distance remapping up to a cutoff point discussed in \cref{sec:significance_measure}.


\begin{figure*}
\includegraphics[width=\textwidth]{sources/method/parabola_switch_to_less_lines.pdf}
\caption{Different preliminary variants of the proposed algorithm on a parabola segment.}
\label{parabola_switch_to_less_lines}
\end{figure*}

























































